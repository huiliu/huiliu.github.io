<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>MySQL通用调优原则 &mdash; Learning 0.9 documentation</title>
    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-3.3.4/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-3.3.4/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.9',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-3.3.4/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="Learning 0.9 documentation" href="index.html" />
    <link rel="next" title="MySQL中的索引-读书笔记" href="mysql_key.html" />
    <link rel="prev" title="MySQL优化-《高性能MySQL》笔记" href="mysql_optimize.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">
          Learning</a>
        <span class="navbar-text navbar-version pull-left"><b>0.9</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="learning.html">学习方法与态度</a></li>
<li class="toctree-l1"><a class="reference internal" href="firefox.html">Speed Up Firefox</a></li>
<li class="toctree-l1"><a class="reference internal" href="bash.html">Learning Bash</a></li>
<li class="toctree-l1"><a class="reference internal" href="tmux.html">tmux</a></li>
<li class="toctree-l1"><a class="reference internal" href="matplot.html">Learning Matplot Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="gnuplot.html">Introduce to the GNUPlot</a></li>
<li class="toctree-l1"><a class="reference internal" href="github.html">使用GitHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="gentoo.html">Gentoo点滴</a></li>
<li class="toctree-l1"><a class="reference internal" href="freebsd.html">FreeBSD点滴</a></li>
<li class="toctree-l1"><a class="reference internal" href="datamining.html">学习数据挖掘</a></li>
<li class="toctree-l1"><a class="reference internal" href="rpm.html">RPM软件包</a></li>
<li class="toctree-l1"><a class="reference internal" href="vim.html">VIM Tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="php.html">PHP点滴</a></li>
<li class="toctree-l1"><a class="reference internal" href="nginx_directive.html">Nginx指令介绍</a></li>
<li class="toctree-l1"><a class="reference internal" href="mediawiki.html">MediaWiki点滴</a></li>
<li class="toctree-l1"><a class="reference internal" href="docker.html">docker使用小记</a></li>
<li class="toctree-l1"><a class="reference internal" href="mail.html">邮件系统-Postfix, Dovecot, MySQL和Postfixadmin</a></li>
<li class="toctree-l1"><a class="reference internal" href="lvm.html">LVM基础知识</a></li>
<li class="toctree-l1"><a class="reference internal" href="samba_ads.html">samba集成Active Directory</a></li>
<li class="toctree-l1"><a class="reference internal" href="samba_basic.html">Samba</a></li>
<li class="toctree-l1"><a class="reference internal" href="disk_quota.html">磁盘配额管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="yslow.html">Best Practices for Speeding Up Your Web Site</a></li>
<li class="toctree-l1"><a class="reference internal" href="http_header.html">HTTP Header</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="kernel.html">学习内核相关知识</a></li>
<li class="toctree-l1"><a class="reference internal" href="lsp01.html">Linux系统编程（一） IO基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="epoll_man.html">epoll(7)</a></li>
<li class="toctree-l1"><a class="reference internal" href="epoll.html">epoll API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="pxe.html">通过PXE安装Linux</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="sql.html">Learning SQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="mysql_io_benchmark.html">测试MySQL服务器性能</a></li>
<li class="toctree-l1"><a class="reference internal" href="mysql_master_slave.html">MySQL配置Master-Slave</a></li>
<li class="toctree-l1"><a class="reference internal" href="mysql_high_availability.html">MySQL的高可用方案（一）</a></li>
<li class="toctree-l1"><a class="reference internal" href="mysql_privileges.html">MySQL权限管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="mysql_backup.html">MySQL数据库的备份</a></li>
<li class="toctree-l1"><a class="reference internal" href="mongodb.html">MongoDB</a></li>
<li class="toctree-l1"><a class="reference internal" href="mysql_logs.html">MySQL日志相关服务器变量</a></li>
<li class="toctree-l1"><a class="reference internal" href="mysql_optimize.html">MySQL优化-《高性能MySQL》笔记</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">MySQL通用调优原则</a></li>
<li class="toctree-l1"><a class="reference internal" href="mysql_key.html">MySQL中的索引-读书笔记</a></li>
<li class="toctree-l1"><a class="reference internal" href="mysql_status.html">MySQL服务器状态</a></li>
<li class="toctree-l1"><a class="reference internal" href="mysql_replication.html">MySQL复制</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="secure_task.html">运维常用工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="tcp-wrappers.html">简易防火墙TCP-Wrapper</a></li>
<li class="toctree-l1"><a class="reference internal" href="selinux.html">探索SELinux</a></li>
<li class="toctree-l1"><a class="reference internal" href="intrusion.html">入侵检测与响应</a></li>
<li class="toctree-l1"><a class="reference internal" href="penetration-testing.html">渗透测试</a></li>
<li class="toctree-l1"><a class="reference internal" href="snort.html">入侵检测工具－Snort</a></li>
<li class="toctree-l1"><a class="reference internal" href="openvas.html">学习弱点扫描工具-openVAS</a></li>
<li class="toctree-l1"><a class="reference internal" href="jail.html">如何让特定用户通过SSH登陆后自动chroot？</a></li>
<li class="toctree-l1"><a class="reference internal" href="logfilter.html">Apache日志过滤－是否可以用来预防DDOS</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="zabbix.html">配置Zabbix</a></li>
<li class="toctree-l1"><a class="reference internal" href="net-snmp.html">Net-SNMP使用心得</a></li>
<li class="toctree-l1"><a class="reference internal" href="puppet.html">配置管理工具-Puppet</a></li>
<li class="toctree-l1"><a class="reference internal" href="foreman.html">Nginx+Foreman+Passenger</a></li>
<li class="toctree-l1"><a class="reference internal" href="nagios.html">监控工具-Nagios</a></li>
<li class="toctree-l1"><a class="reference internal" href="proc.html">文件系统/proc</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="jenkins.html">赤兔项目持续集成系统－Jenkins CI部署</a></li>
<li class="toctree-l1"><a class="reference internal" href="svn.html">SVN Q/A</a></li>
<li class="toctree-l1"><a class="reference internal" href="svn_mirror.html">SVN仓库安全之镜像备份</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="sscanf.html">一个字符引发的问题 - sscanf</a></li>
<li class="toctree-l1"><a class="reference internal" href="unicode.html">折磨人的字符编码问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="comm_pipe.html">命令行管道编程</a></li>
<li class="toctree-l1"><a class="reference internal" href="libpcap.html">抓包-libpcap</a></li>
<li class="toctree-l1"><a class="reference internal" href="libevent.html">Learning libevent Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="epoll.html">epoll API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="python.html">Learning Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="spider.html">爬虫框架 - scrapy</a></li>
<li class="toctree-l1"><a class="reference internal" href="pymysql.html">Python-MySQL使用心得</a></li>
<li class="toctree-l1"><a class="reference internal" href="python_network.html">Python网络库的使用</a></li>
<li class="toctree-l1"><a class="reference internal" href="code_evolution.html">Code Evolution</a></li>
<li class="toctree-l1"><a class="reference internal" href="python_var.html">Pyhton中变量的作用域</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="proverb.html">箴言</a></li>
<li class="toctree-l1"><a class="reference internal" href="children.html">小孩教育</a></li>
<li class="toctree-l1"><a class="reference internal" href="song.html">知足</a></li>
<li class="toctree-l1"><a class="reference internal" href="holdteam.html">保持团队稳定</a></li>
<li class="toctree-l1"><a class="reference internal" href="live_finace.html">神仙打架-互联网金融</a></li>
<li class="toctree-l1"><a class="reference internal" href="travel_wuyi.html">武夷山之行</a></li>
<li class="toctree-l1"><a class="reference internal" href="iamprogramer.html">程序人生</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">MySQL通用调优原则</a><ul>
<li><a class="reference internal" href="#id1">查询缓存</a><ul>
<li><a class="reference internal" href="#id3">相关服务器变量和状态值</a></li>
<li><a class="reference internal" href="#tips">Tips 关注点</a></li>
</ul>
</li>
<li><a class="reference internal" href="#myisam">MyISAM的键缓存</a><ul>
<li><a class="reference internal" href="#id4">缓存命中率</a></li>
<li><a class="reference internal" href="#id5">缓存使用率</a></li>
<li><a class="reference internal" href="#id6">MyISAM数据块的大小</a></li>
</ul>
</li>
<li><a class="reference internal" href="#innodb">InnoDB缓冲池</a></li>
<li><a class="reference internal" href="#id7">线程缓存</a></li>
<li><a class="reference internal" href="#id8">表缓存</a></li>
<li><a class="reference internal" href="#id9">InnoDB数据字典</a></li>
<li><a class="reference internal" href="#myisam-i-o">MyISAM I/O调优</a></li>
<li><a class="reference internal" href="#innodb-i-o">InnoDB I/O调优</a><ul>
<li><a class="reference internal" href="#id10">InnoDB表空间</a></li>
<li><a class="reference internal" href="#binlog">Binlog的写入</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id11">参考资源</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="mysql_optimize.html" title="Previous Chapter: MySQL优化-《高性能MySQL》笔记"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; MySQL优化-《高性能M...</span>
    </a>
  </li>
  <li>
    <a href="mysql_key.html" title="Next Chapter: MySQL中的索引-读书笔记"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">MySQL中的索引-读书笔记 &raquo;</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="#">MySQL通用调优原则</a><ul>
<li><a class="reference internal" href="#id1">查询缓存</a><ul>
<li><a class="reference internal" href="#id3">相关服务器变量和状态值</a></li>
<li><a class="reference internal" href="#tips">Tips 关注点</a></li>
</ul>
</li>
<li><a class="reference internal" href="#myisam">MyISAM的键缓存</a><ul>
<li><a class="reference internal" href="#id4">缓存命中率</a></li>
<li><a class="reference internal" href="#id5">缓存使用率</a></li>
<li><a class="reference internal" href="#id6">MyISAM数据块的大小</a></li>
</ul>
</li>
<li><a class="reference internal" href="#innodb">InnoDB缓冲池</a></li>
<li><a class="reference internal" href="#id7">线程缓存</a></li>
<li><a class="reference internal" href="#id8">表缓存</a></li>
<li><a class="reference internal" href="#id9">InnoDB数据字典</a></li>
<li><a class="reference internal" href="#myisam-i-o">MyISAM I/O调优</a></li>
<li><a class="reference internal" href="#innodb-i-o">InnoDB I/O调优</a><ul>
<li><a class="reference internal" href="#id10">InnoDB表空间</a></li>
<li><a class="reference internal" href="#binlog">Binlog的写入</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id11">参考资源</a></li>
</ul>
</li>
</ul>

<div id="sourcelink">
  <a href="_sources/mysql_tuning.txt"
     rel="nofollow">Source</a>
</div>
<form action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
    <div class="col-md-9">
      
  <div class="section" id="mysql">
<h1>MySQL通用调优原则<a class="headerlink" href="#mysql" title="Permalink to this headline">¶</a></h1>
<p>如果服务器使用单一存储引擎，调优相对容易的多。如，只使用MyISAM表，就可以完全禁止
InnoDB；反之类似。</p>
<div class="section" id="id1">
<h2>查询缓存<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>MySQL可以缓存将查询结果，当客户再次查询时会直接将结果返回给用户。当服务端收到一
个请求后，在解析请求之前会先检查<em>查询缓存</em>是否有相应结果，如果有，则直接将结
果返回给用户，并增加<code class="docutils literal"><span class="pre">Qcache_hits</span></code>的计数（而不增加<code class="docutils literal"><span class="pre">Com_select</span></code>计算）
。由于检查缓存时MySQL会使用查询语句，而且要求完全一致，区别大小写。</p>
<p>即使开启查询缓存的功能，MySQL也不会缓存所有的查询。下列情况的查询就不会被缓存：<a class="footnote-reference" href="#query-cache" id="id2">[1]</a></p>
<ul>
<li><p class="first">查询是一个外部查询的子查询</p>
</li>
<li><p class="first">被存储函数(stored function)，触发器(trigger)，事务(event)执行的查询</p>
</li>
<li><p class="first">查询使用了用户自定义函数或存储函数</p>
</li>
<li><p class="first">查询使用了用户变量或本地存储程序的变量</p>
</li>
<li><p class="first">数据库<em>mysql, INFORMATION_SCHEMA和performance_schema</em>中的表</p>
</li>
<li><p class="first">任何下面形式的查询</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">SELECT</span> <span class="p">...</span> <span class="k">LOCK</span> <span class="k">IN</span> <span class="k">SHARE</span> <span class="k">MODE</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="p">...</span> <span class="k">FOR</span> <span class="k">UPDATE</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="p">...</span> <span class="k">INTO</span> <span class="n">OUTFILE</span> <span class="p">...</span>
<span class="k">SELECT</span> <span class="p">...</span> <span class="k">INTO</span> <span class="n">DUMPFILE</span> <span class="p">...</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="p">...</span> <span class="k">WHERE</span> <span class="n">autoincrement_col</span> <span class="k">IS</span> <span class="k">NULL</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p class="first">另外，如果查询中包含以下特殊函数，查询结果也不会被缓存。</p>
</li>
</ul>
<div class="section" id="id3">
<h3>相关服务器变量和状态值<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>与查询缓存相关的MySQL变量有：(不同版本可能有所不同，下面为MariaDB 5.5.36）</p>
<table border="1" class="docutils">
<colgroup>
<col width="39%" />
<col width="12%" />
<col width="49%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Variable_name</td>
<td>默认值</td>
<td>说明</td>
</tr>
<tr class="row-even"><td>query_cache_limit</td>
<td>1048576</td>
<td>可以缓存的最大查询结果（字节）</td>
</tr>
<tr class="row-odd"><td>query_cache_min_res_unit</td>
<td>4096</td>
<td>缓存最小分配空间</td>
</tr>
<tr class="row-even"><td>query_cache_size</td>
<td>0</td>
<td>缓存大小</td>
</tr>
<tr class="row-odd"><td>query_cache_strip_comments</td>
<td>OFF</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>query_cache_type</td>
<td>ON</td>
<td>缓存类型（如何缓存）</td>
</tr>
<tr class="row-odd"><td>query_cache_wlock_invalidate</td>
<td>OFF</td>
<td>详情请看<a class="reference external" href="http://dev.mysql.com/doc/refman/5.5/en/server-system-variables.html#sysvar_query_cache_wlock_invalidate">MySQL Manual</a></td>
</tr>
</tbody>
</table>
<p>与查询缓存相关的状态值有：</p>
<table border="1" class="docutils">
<colgroup>
<col width="36%" />
<col width="64%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Variable_name</td>
<td>说明</td>
</tr>
<tr class="row-even"><td>Qcache_free_blocks</td>
<td>查询缓存中未使用的内存块</td>
</tr>
<tr class="row-odd"><td>Qcache_free_memory</td>
<td>查询缓存中未使用的内存</td>
</tr>
<tr class="row-even"><td>Qcache_hits</td>
<td>缓存命中次数</td>
</tr>
<tr class="row-odd"><td>Qcache_inserts</td>
<td>插入记录至缓存中的次数</td>
</tr>
<tr class="row-even"><td>Qcache_lowmem_prunes</td>
<td>当内存不足时从查询缓存中删除的记录数</td>
</tr>
<tr class="row-odd"><td>Qcache_not_cached</td>
<td>没有被缓存的查询次数</td>
</tr>
<tr class="row-even"><td>Qcache_queries_in_cache</td>
<td>缓存中的查询数</td>
</tr>
<tr class="row-odd"><td>Qcache_total_blocks</td>
<td>查询缓冲的总块数</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="tips">
<h3>Tips 关注点<a class="headerlink" href="#tips" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">查询命中率</p>
<div class="math">
\[\% = \frac{Qcache\_hits}{Qcache\_hits + Com_select}\]</div>
</li>
</ul>
</div>
</div>
<div class="section" id="myisam">
<h2>MyISAM的键缓存<a class="headerlink" href="#myisam" title="Permalink to this headline">¶</a></h2>
<p>MyISAM自身只缓存了索引，没有数据（数据由操作系统缓存）。最重要的选项是<code class="docutils literal"><span class="pre">key_buffer_size</span></code>。默认情况下，MyISAM将所有索引缓存在默认的键缓存中，但是可
以创建多个命名键缓存区。例如在配置文件中添加下面两行，就会创建名为<em>key_buffer_1</em>和<em>key_buffer_2</em>的两个键缓存区，大小都为1G。此时MySQL就有三
个键缓存区了。</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">key_buffer_1.key_buffer_size</span> <span class="o">=</span> <span class="s">1G</span>
<span class="na">key_buffer_2.key_buffer_size</span> <span class="o">=</span> <span class="s">1G</span>
</pre></div>
</div>
<p>可以通过<em>CACHE INDEX</em>将表映射到缓存。如，下面将表t1, t2的索引保存到<em>key_buffer_1</em>。</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">CACHE</span> <span class="k">INDEX</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="k">IN</span> <span class="n">key_buffer_1</span><span class="p">;</span>
</pre></div>
</div>
<p>通过<code class="docutils literal"><span class="pre">SHOW</span> <span class="pre">STATUS</span></code>和<code class="docutils literal"><span class="pre">SHOW</span> <span class="pre">VARIABLES</span></code>监视键缓冲区的使用情况和性能。主
要指标有：<code class="docutils literal"><span class="pre">缓存命中率</span></code>和<code class="docutils literal"><span class="pre">缓存使用率</span></code></p>
<div class="section" id="id4">
<h3>缓存命中率<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<div class="math">
\[\begin{equation}
    \% = \frac{key_read}{key_read_requests}\times 100
\end{equation}\]</div>
</div>
<div class="section" id="id5">
<h3>缓存使用率<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<div class="math">
\[\begin{equation}
    \% = \frac{key_blocks_unused * key_cache_block_size}{key_buffer_size}\times 100
\end{equation}\]</div>
<p>分配键缓存大小时，了解MyISAM索引的大小比较有帮助，使用下面命令可以计算索引文件的
大小。</p>
<div class="highlight-bash"><div class="highlight"><pre>du -sch <span class="sb">`</span>find /var/lib/mysql -name <span class="s1">&#39;*.MYI&#39;</span><span class="sb">`</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h3>MyISAM数据块的大小<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>键数据块的大小非常重要，因为它会影响MyISAM、操作系统和文件系统间的交互。如果键数
据块太小，就会导致写入排队的情况。如果键数据块大小与操作系统相匹配，可以避免写入
等待。</p>
<p><code class="docutils literal"><span class="pre">myisam_block_size</span></code>变量控制着键缓存块的大小，也可以在<code class="docutils literal"><span class="pre">CREATE</span> <span class="pre">TABLE</span></code>或<code class="docutils literal"><span class="pre">CREATE</span> <span class="pre">INDEX</span></code>语句中为每一个键定义<code class="docutils literal"><span class="pre">KEY_BLOCK_SIZE</span></code>选项来控制键的大小。</p>
</div>
</div>
<div class="section" id="innodb">
<h2>InnoDB缓冲池<a class="headerlink" href="#innodb" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id7">
<h2>线程缓存<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">thread_cache_size</span></code>定义了MySQL能在缓存中保存的线程数量。如果一个新的连接被创
建且缓存中有线程，MySQL就会从缓存中取出一个并赋给它连接；当连接关闭时，MySQL会回
收线程存放到缓存中，如果（线程）缓存中已经存满，则会将其销毁。</p>
<p>通过观察变量<code class="docutils literal"><span class="pre">thread_created</span></code>的值可以确定线程缓存是否足够大。如果每秒创建的
线程数量少于10个，缓存的大小就是够的。</p>
<p>对大多数情况而言，非常巨大的线程缓存是没有必要的。每个在缓存中的线程通常会消耗
256KB内存。</p>
</div>
<div class="section" id="id8">
<h2>表缓存<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p>表缓存有助于复用资源。如：当查询要求访问MyISAM表时，MySQL就可以从缓存中取出一个
文件描述符，而不是打开一个文件。</p>
<p>表缓存被分为两个部分：一部分为打开表）；另一部分为表的定义。分别由变量<code class="docutils literal"><span class="pre">table_open_cache</span></code>和<code class="docutils literal"><span class="pre">table_definition_cache</span></code>定义。表的定义（解析过的
.frm文件）和其它资源（如文件描述符）是隔离的。打开的表仍然是基于每个线程、每个使
用的表。而表的定义是全局的，可以在所有连接中共享。</p>
<p>如果状态<code class="docutils literal"><span class="pre">opened_tables</span></code>的值很大或者不断上升，就说明缓存不够大，应该增加系
统变量<code class="docutils literal"><span class="pre">table_cache</span></code>（或<code class="docutils literal"><span class="pre">table_open_cache</span></code>）的值。将表缓存变得很大的
唯一坏处就是有很多MyISAM表的时候，会导致较长的关闭时间，因为要冲刷键数据块，而且
表要被标记为不再打开。同样也会导致<code class="docutils literal"><span class="pre">FLUSH</span> <span class="pre">TABLES</span> <span class="pre">WITH</span> <span class="pre">READ</span> <span class="pre">LOCK</span></code>需要较长时
间才能完成。</p>
<p>如果收到MySQL不能打开更多文件的提示，需要在配置文件中使用<code class="docutils literal"><span class="pre">open_files_limit</span></code>来增加可打开文件数。</p>
</div>
<div class="section" id="id9">
<h2>InnoDB数据字典<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="myisam-i-o">
<h2>MyISAM I/O调优<a class="headerlink" href="#myisam-i-o" title="Permalink to this headline">¶</a></h2>
<p>此处I/O主要指的是数据写入磁盘，由于写缓存的存在，MySQL的性能会大大提高，但是也会
引起一些风险，如突然断电，系统崩溃，缓存中的数据没有写入到磁盘，就可能导致数据丢
失，即使是恢复，也可能需要相当长的时间。</p>
<p>通常MyISAM在每次写入之后就会把索引的变化刷写到磁盘上。如果打算对一个表进行很多改
变，那么把它们组成一个批处理会快很多。</p>
<p><code class="docutils literal"><span class="pre">LOCK</span> <span class="pre">TABLES</span></code>可以将写延迟到对表解锁，所以可以用来精确的控制延迟写入。</p>
<p>变量<code class="docutils literal"><span class="pre">delay_key_write</span></code>可以控制MyISAM键的延迟写入。可以取下面三个值：</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">OFF</span></code> MyISAM每次写入后就把键缓冲区中修改过的数据块刷写到磁盘上，除非表被<code class="docutils literal"><span class="pre">LOCK</span> <span class="pre">TABLES</span></code>锁定。</li>
<li><code class="docutils literal"><span class="pre">ON</span></code>  键延迟写入被开启。不过只对使用<code class="docutils literal"><span class="pre">DELAY_KEY_WRITE</span></code>项创建的表有效</li>
<li><code class="docutils literal"><span class="pre">ALL</span></code> 所有MyISAM表都使用键延迟写入。</li>
</ul>
<p>键延迟写入对性能提高有一定帮助，但不会带来飞跃。</p>
<p>选项<code class="docutils literal"><span class="pre">myisam_recover_options</span></code>控制着MyISAM查找和修复错误的方式，取值如下：</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">DEFAULT</span></code>或不设置   MySQL会修复所有被标记为崩溃及没有标记为干净关闭的表</li>
<li><code class="docutils literal"><span class="pre">BACKUP</span></code>  MySQL会将数据文件备份到一个.bak文件，可以方便随后检查</li>
<li><code class="docutils literal"><span class="pre">FORCE</span></code>   即使.MYD丢失一行，恢复也会继续</li>
<li><code class="docutils literal"><span class="pre">QUICK</span></code></li>
</ul>
<p>选项<code class="docutils literal"><span class="pre">myisam_use_mmap</span></code>可以开启使用内存映射打开数据文件。</p>
</div>
<div class="section" id="innodb-i-o">
<h2>InnoDB I/O调优<a class="headerlink" href="#innodb-i-o" title="Permalink to this headline">¶</a></h2>
<p>InnoDB使用事务日志来减少提交事务的开销。每次事务提交时，并不会将缓存池写入到磁盘
，而是记录到事务日志中。InnoDB最终还是要将数据变化写入到数据文件，它是通过后台线
程智能的将数据变化写入文件（因为每次事务，不同事务的写入操作可能会进行随机I/O，
而该线程会将事务中的I/O以高效的顺序I/O写入至数据文件）。</p>
<p>事务日志也使用了缓存，即日志缓存。大小由变量<code class="docutils literal"><span class="pre">innodb_log_buffer_size</span></code>来控制
，通常大小为1-8M，对大型事务，可能需要实际调整。在InnoDB数据发生变更时，它会将变
化写入至日志缓存（内存）中，当缓存满、事务提交或每一秒任一条件满足，InnoDB会将日
志缓冲区的写入磁盘日志文件中。</p>
<p>事务日志文件的大小由<code class="docutils literal"><span class="pre">innodb_log_file_size</span></code>和<code class="docutils literal"><span class="pre">innodb_log_files_in_group</span></code>两个变量来控制。默认日志文件为2个，大小均为5M。对
高负载，256M应该可以满足需求，总大小上限为4G。日志文件是以循环的方式写入的，即当
记录到达日志底部，则会从顶部重新开始，但是不会覆盖没有写入至数据文件的记录。</p>
<p>如果想改变日志文件的大小，需要干净的关闭MySQL，确认日志中所以记录已写入到数据文
件，然后移走原日志文件，重新配置<code class="docutils literal"><span class="pre">innodb_log_file_size</span></code>启动服务器，检查错误
日志，确认没有问题后删除原日志文件。</p>
<p>那么日志缓存又是如何写入到日志文件的呢？前面已经提到过，在三种情况下会将日志缓存
写入磁盘：<em>缓存满、事务提交或每秒</em>。这是通过变量<code class="docutils literal"><span class="pre">innodb_log_at_trx_commit</span></code>来控制的，它可以取下面三个值：</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">0</span></code>   将日志缓存写入到日志文件中，且每秒写入一次，有事务提交时不进行操作</li>
<li><code class="docutils literal"><span class="pre">1</span></code>   将日志写到日志文件中，且在事务提交时把缓存写入到<strong>持久存储</strong>中
（确保写入硬盘）。默认设置</li>
<li><code class="docutils literal"><span class="pre">2</span></code>   每次事务提交时将日志缓存写入到日志文件中，但不进行清理。InnoDB每秒会
清理一次。MySQL崩溃时，事务不会丢失，但是数据存储崩溃、掉电则可能丢失事物</li>
</ul>
<p>注意写入到文件和写入到持久存储是有差别的。（系统缓存的存在）</p>
<p>另外变量<code class="docutils literal"><span class="pre">innodb_flush_log_at_atx_commit</span></code>也对I/O有着非常大的影响。</p>
<p>变量<code class="docutils literal"><span class="pre">innodb_flush_method</span></code>控制InnoDB如何与文件系统进行交互。</p>
<div class="section" id="id10">
<h3>InnoDB表空间<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>InnoDB将数据保存在表空间中。使用变量<code class="docutils literal"><span class="pre">innodb_data_file_path</span></code>定义表空间文件
，<code class="docutils literal"><span class="pre">innodb_data_home_dir</span></code>定义表空间文件所在的目录。如：</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">innodb_data_home_dir</span> <span class="o">=</span> <span class="s">/var/lib/mysql</span>
<span class="na">innodb_data_file_path</span> <span class="o">=</span> <span class="s">ibdata1:1G;ibdata2:1G;ibdata3:1G[:autoextend[:max:2G]]</span>
</pre></div>
</div>
<p>InnoDB会依序向这些文件中写入数据，第一个写满了再写第二个……所以将这些文件分部存储
至不同磁盘上并没有效果。在最后一个文件后面，我们可以使用<code class="docutils literal"><span class="pre">autoextend</span></code>，当表
空间耗尽（即所以文件都写满）后，最后一个文件会自动增长，不过文件大小是只增不减的
。为了防止文件过大，可以使用<code class="docutils literal"><span class="pre">max:2G</span></code>来设定一个上限。</p>
<p>变量<code class="docutils literal"><span class="pre">innodb_file_per_table</span></code>可以使用InnoDB为每一表使用一个文件（在数据库目
录中以“tbl_name.idb”保存数据），这样带来一些便利的同时会浪费更多的空间。</p>
<p>变量<code class="docutils literal"><span class="pre">innodb_max_purge_lag</span></code></p>
<p>双写缓存。变量<code class="docutils literal"><span class="pre">innodb_doublewrite</span></code>控制。</p>
</div>
<div class="section" id="binlog">
<h3>Binlog的写入<a class="headerlink" href="#binlog" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">sync_binlog</span></code>控制MySQL如何将binlog写入到磁盘。默认为<code class="docutils literal"><span class="pre">0</span></code>，即MySQL不会进
行任何刷写操作，何时把日志持久化至存储设备由操作系统来控制。</p>
<p>变量<code class="docutils literal"><span class="pre">expire_logs_days</span></code>用来设置日志的有效期。不要使用<em>rm</em>删除binlog，因
为你不知道binlog是否已经同步至slave服务器。可以使用<code class="docutils literal"><span class="pre">PURGE</span> <span class="pre">MASTER</span> <span class="pre">LOGS</span></code>删除
binlog。</p>
</div>
</div>
<div class="section" id="id11">
<h2>参考资源<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>《高性能MySQL》</li>
</ol>
<table class="docutils footnote" frame="void" id="query-cache" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td><a class="reference external" href="http://dev.mysql.com/doc/refman/5.5/en/query-cache-operation.html">How the Query Cache Operates</a></td></tr>
</tbody>
</table>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="_sources/mysql_tuning.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright 2013, Liu Hui.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>