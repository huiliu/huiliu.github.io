

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Nginx指令介绍 &mdash; Learning 0.1 documentation</title>
    
    <link rel="stylesheet" href="http://sphinx-doc.org/_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="http://sphinx-doc.org/_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="http://sphinx-doc.org/_static/jquery.js"></script>
    <script type="text/javascript" src="http://sphinx-doc.org/_static/underscore.js"></script>
    <script type="text/javascript" src="http://sphinx-doc.org/_static/doctools.js"></script>
    <link rel="top" title="Learning 0.1 documentation" href="index.html" />
    <link rel="prev" title="运维常用工具" href="secure_task.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="secure_task.html" title="运维常用工具"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Learning 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Nginx指令介绍</a><ul>
<li><a class="reference internal" href="#proxy-cache">Proxy_cache相关指令</a><ul>
<li><a class="reference internal" href="#id3">proxy_cache</a></li>
<li><a class="reference internal" href="#proxy-cache-path">proxy_cache_path</a></li>
<li><a class="reference internal" href="#proxy-cache-bypass">proxy_cache_bypass</a></li>
<li><a class="reference internal" href="#proxy-no-cache">proxy_no_cache</a></li>
<li><a class="reference internal" href="#proxy-cache-key">proxy_cache_key</a></li>
<li><a class="reference internal" href="#proxy-cache-valid">proxy_cache_valid</a></li>
<li><a class="reference internal" href="#proxy-cache-lock">proxy_cache_lock</a></li>
<li><a class="reference internal" href="#proxy-cache-lock-timeout">proxy_cache_lock_timeout</a></li>
<li><a class="reference internal" href="#proxy-cache-min-uses">proxy_cache_min_uses</a></li>
<li><a class="reference internal" href="#proxy-cache-use-stale">proxy_cache_use_stale</a></li>
<li><a class="reference internal" href="#proxy-cache-methods">proxy_cache_methods</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id4">问题</a></li>
<li><a class="reference internal" href="#id5">参考资料</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="secure_task.html"
                        title="previous chapter">运维常用工具</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/nginx_directive.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="nginx">
<h1>Nginx指令介绍<a class="headerlink" href="#nginx" title="Permalink to this headline">¶</a></h1>
<p>详细信息请查看<a class="reference external" href="http://nginx.org/">Nginx</a> 原文档(English[#ref1]_, 淘宝中文版<a class="footnote-reference" href="#ref2" id="id1">[2]</a>)</p>
<div class="section" id="proxy-cache">
<h2>Proxy_cache相关指令<a class="headerlink" href="#proxy-cache" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id3">
<h3>proxy_cache<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<div class="highlight-nginx"><div class="highlight"><pre><span class="k">prox_cache</span> <span class="s">zone_name</span> <span class="s">|</span> <span class="no">off</span><span class="p">;</span>
</pre></div>
</div>
<p>为cache指定一个共享存储区。相同的存储区可以在不同的地方使用。如果设定为<em>off</em>可以关闭从上级配置中继承的cache定义。</p>
<p>共享存储区域&#8221;<em>zone_name</em>&#8220;是由指令<tt class="docutils literal"><span class="pre">proxy_cache_path</span></tt>定义的。</p>
</div>
<div class="section" id="proxy-cache-path">
<h3>proxy_cache_path<a class="headerlink" href="#proxy-cache-path" title="Permalink to this headline">¶</a></h3>
<div class="highlight-nginx"><div class="highlight"><pre><span class="k">proxy_cache_path</span>  <span class="s">path</span> <span class="s">[levels=levels]</span> <span class="s">keys_zone=name:size</span>
                    <span class="s">[inactive=time]</span> <span class="s">[max_size=size]</span> <span class="s">[loader_files=number]</span>
                    <span class="s">[loader_sleep=time]</span> <span class="s">[loader_threshold=time]</span><span class="p">;</span>
</pre></div>
</div>
<p>设定缓存的存储路径和其他一些参数。被缓存的数据都存储在文件中。存储在缓存区的key和文件名是通过被代理的URL的MD5值处理后得到的。参数`levels`用于定义缓存的存放级别的。例如：下面的指令：</p>
<div class="highlight-nginx"><div class="highlight"><pre><span class="k">proxy_cache_path</span> <span class="s">/data/nginx/cache</span> <span class="s">*levels*=1:2</span> <span class="s">keys_zone=one:10m</span><span class="p">;</span>
</pre></div>
</div>
<p>被缓存的文件在缓存区中是这样存放的:</p>
<blockquote>
<div>/data/nginx/cache/<em>c</em>/<em>29</em>/b7f54b2df7773722d382f4809d650*29c*</div></blockquote>
<p>A cached response is first written to a temporary file, then a file is renamed. Starting from version 0.8.9 temporary files and the cache can be put on different file systems but be aware that in this case a file is copied across two file systems instead of the cheap rename operation. It is thus recommended that for any given location both cache and a directory holding temporary files set by the proxy_temp_path directive are put on the same file system.
缓存的响应首先写入到一个临时文件，然后进行重命名。</p>
<p>In addition, all active keys and information about data are stored in a shared memory zone, whose name and size are configured by the keys_zone parameter. Cached data that are not accessed during the time specified by the inactive parameter get removed from the cache regardless of their freshness. By default, inactive is set to 10 minutes.</p>
<p>The special process “cache manager” monitors the maximum cache size set by the max_size parameter; when this size is exceeded it removes the least recently used data.</p>
<p>A minute after the start the special process “cache loader” is activated that loads information about previously cached data stored on file system into a cache zone. A load is done in iterations. During one iteration no more than loader_files items are loaded (by default, 100). Besides, the duration of one iteration is limited by the loader_threshold parameter (by default, 200 milliseconds). A pause is made between iterations, configured by the loader_sleep parameter (by default, 50 milliseconds).</p>
</div>
<div class="section" id="proxy-cache-bypass">
<h3>proxy_cache_bypass<a class="headerlink" href="#proxy-cache-bypass" title="Permalink to this headline">¶</a></h3>
<div class="highlight-nginx"><div class="highlight"><pre><span class="k">proxy_cache_bypass</span> <span class="s">string</span> <span class="s">...</span><span class="p">;</span>
</pre></div>
</div>
<p>定义在哪些情况下，响应数据不从缓存中取得。当至少有一个字符参数不为空(&#8220;&#8221;)且不等于&#8221;0&#8221;，响应就不会从缓存中提取。</p>
<p><tt class="docutils literal"><span class="pre">proxy_cache_bypass</span></tt>的功能与下面的<tt class="docutils literal"><span class="pre">proxy_no_cache</span></tt>相同。</p>
</div>
<div class="section" id="proxy-no-cache">
<h3>proxy_no_cache<a class="headerlink" href="#proxy-no-cache" title="Permalink to this headline">¶</a></h3>
<div class="highlight-nginx"><div class="highlight"><pre><span class="k">proxy_no_cache</span> <span class="s">string</span> <span class="s">...</span><span class="p">;</span>
</pre></div>
</div>
<p>与<tt class="docutils literal"><span class="pre">proxy_cache_bypass</span></tt>相同。</p>
</div>
<div class="section" id="proxy-cache-key">
<h3>proxy_cache_key<a class="headerlink" href="#proxy-cache-key" title="Permalink to this headline">¶</a></h3>
<div class="highlight-nginx"><div class="highlight"><pre><span class="k">proxy_cacke_key</span> <span class="nv">$scheme$proxy_host$request_uri</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="proxy-cache-valid">
<h3>proxy_cache_valid<a class="headerlink" href="#proxy-cache-valid" title="Permalink to this headline">¶</a></h3>
<div class="highlight-nginx"><div class="highlight"><pre><span class="k">proxy_cache_valid</span> <span class="mi">200</span> <span class="mi">302</span> <span class="mi">10m</span><span class="p">;</span>
<span class="k">proxy_cache_valid</span> <span class="mi">404</span> <span class="mi">1m</span><span class="p">;</span>
<span class="k">proxy_cache_valid</span> <span class="s">any</span> <span class="mi">1m</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="proxy-cache-lock">
<h3>proxy_cache_lock<a class="headerlink" href="#proxy-cache-lock" title="Permalink to this headline">¶</a></h3>
<div class="highlight-nginx"><div class="highlight"><pre><span class="k">proxy_cache_lock</span> <span class="no">on</span> <span class="s">|</span> <span class="no">off</span>
</pre></div>
</div>
</div>
<div class="section" id="proxy-cache-lock-timeout">
<h3>proxy_cache_lock_timeout<a class="headerlink" href="#proxy-cache-lock-timeout" title="Permalink to this headline">¶</a></h3>
<div class="highlight-nginx"><div class="highlight"><pre><span class="k">proxy_cache_lock_timeout</span> <span class="s">5s</span>
</pre></div>
</div>
</div>
<div class="section" id="proxy-cache-min-uses">
<h3>proxy_cache_min_uses<a class="headerlink" href="#proxy-cache-min-uses" title="Permalink to this headline">¶</a></h3>
<div class="highlight-nginx"><div class="highlight"><pre><span class="k">proxy_cache_min_uses</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="proxy-cache-use-stale">
<h3>proxy_cache_use_stale<a class="headerlink" href="#proxy-cache-use-stale" title="Permalink to this headline">¶</a></h3>
<div class="highlight-nginx"><div class="highlight"><pre><span class="k">proxy_cache_use_stale</span> <span class="s">error</span> <span class="s">|</span> <span class="s">timeout</span> <span class="s">|</span> <span class="s">invalid_header</span> <span class="s">|</span> <span class="s">updating</span> <span class="s">|</span> <span class="s">http_500</span>
                        <span class="s">|</span> <span class="s">http_502</span> <span class="s">|</span> <span class="s">http_503</span> <span class="s">|</span> <span class="s">http_504</span> <span class="s">|</span> <span class="s">http_404</span> <span class="s">|</span> <span class="no">off</span> <span class="s">...</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="proxy-cache-methods">
<h3>proxy_cache_methods<a class="headerlink" href="#proxy-cache-methods" title="Permalink to this headline">¶</a></h3>
<div class="highlight-nginx"><div class="highlight"><pre><span class="k">proxy_cache_methods</span> <span class="s">GET</span> <span class="s">|</span> <span class="s">HEAD</span> <span class="s">|</span> <span class="s">POST</span> <span class="s">...</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id4">
<h2>问题<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><strong>proxy cache</strong>的流程是什么样的？</li>
<li><tt class="docutils literal"><span class="pre">proxy_cache</span></tt>, <tt class="docutils literal"><span class="pre">proxy_temp_path</span></tt>, <tt class="docutils literal"><span class="pre">proxy_store</span></tt>三种存储有什么差别？</li>
</ul>
</div>
<div class="section" id="id5">
<h2>参考资料<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<table class="docutils footnote" frame="void" id="ref1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td><a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html">http://nginx.org/en/docs/http/ngx_http_proxy_module.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ref2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[2]</a></td><td><a class="reference external" href="http://tengine.taobao.org/nginx_docs/cn/docs/http/ngx_http_proxy_module.html">http://tengine.taobao.org/nginx_docs/cn/docs/http/ngx_http_proxy_module.html</a></td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="secure_task.html" title="运维常用工具"
             >previous</a> |</li>
        <li><a href="index.html">Learning 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Liu Hui.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>